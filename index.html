<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>多语言 Word Search H5（v3 · 至少6词 · 自动计时）</title>
  <style>
    :root { --bg1:#f8fafc; --bg2:#eef2f7; --card:#fff; --text:#0f172a; --muted:#64748b; --accent:#4f46e5; --ok:#059669; --warn:#ef4444; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; color: var(--text); background: linear-gradient(to bottom, var(--bg1), var(--bg2)); }
    .container { max-width: 1120px; margin: 0 auto; padding: 24px; }
    h1 { font-size: 24px; margin: 0; font-weight: 800; letter-spacing: .2px; display: flex; align-items: center; gap: 8px; }
    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    select, textarea, input { border: 1px solid #e5e7eb; border-radius: 12px; padding: 8px 12px; background: #fff; }
    button { border: 0; padding: 10px 14px; border-radius: 12px; background: var(--accent); color: #fff; cursor: pointer; font-weight: 700; }
    button.secondary { background: #e2e8f0; color: #0f172a; }
    button.ghost { background: transparent; color: var(--text); border: 1px solid #e5e7eb; }
    .grid-wrap { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-top: 16px; }
    .card { background: var(--card); border-radius: 16px; box-shadow: 0 6px 20px rgba(15, 23, 42, .08); }
    .card-h { padding: 16px 16px 8px; font-weight: 700; display:flex; align-items:center; justify-content:space-between; }
    .card-c { padding: 16px; }
    .board { display: inline-grid; user-select: none; position: relative; }
    .overlay { position:absolute; inset:0; background: rgba(255,255,255,.6); backdrop-filter: blur(1px); border-radius: 12px; display:none; align-items:center; justify-content:center; font-weight:800; font-size:18px; color: var(--warn); }
    .cell { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border: 1px solid #e5e7eb; font-weight: 700; border-radius: 8px; margin: 3px; background: rgba(255,255,255,.9); transition: background .12s ease, transform .05s; }
    .cell:hover { background: #f1f5f9; }
    .cell.drag { outline: 2px dashed #a5b4fc; outline-offset: -4px; }
    .word { display: flex; gap: 8px; align-items: center; padding: 6px 8px; border: 1px solid #e5e7eb; border-radius: 12px; background: #fff; }
    .word .dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
    .word.found { background: #ecfdf5; border-color: #34d399; text-decoration: line-through; opacity:.85; }
    .status { display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; }
    .muted { color: var(--muted); font-size: 13px; }
    .time { font-weight: 800; min-width: 68px; text-align: right; }
    .done { color: var(--ok); font-weight:700; }
    .timeup { color: var(--warn); font-weight:700; display:none; }
    .levelbar { display:flex; align-items:center; gap:8px; }
    .leveltag { background:#e2e8f0; color:#0f172a; padding:4px 10px; border-radius:999px; font-weight:700; }
    .cta { display:flex; gap:8px; align-items:center; }
    @media (max-width: 900px) { .grid-wrap { grid-template-columns: 1fr; } }

    /* Landing Screen */
    .landing { position: fixed; inset:0; display:flex; align-items:center; justify-content:center; background: radial-gradient(1200px 600px at 50% -10%, #fff 0, #eef2f7 60%, #e2e8f0 100%); z-index: 999; }
    .landing .panel { background:#ffffff; border:1px solid #e5e7eb; border-radius: 24px; padding: 24px; width: min(680px, 92vw); box-shadow: 0 20px 60px rgba(15, 23, 42, .12); }
    .landing h2 { margin: 0 0 12px 0; font-size: 28px; }
    .landing p { margin: 4px 0 16px 0; color: var(--muted); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .row > * { flex: 1 1 auto; }
    .panel .footer { display:flex; justify-content: flex-end; gap: 10px; margin-top: 16px; }
  </style>
</head>
<body>
  <!-- Landing Screen -->
  <div id="landing" class="landing">
    <div class="panel">
      <h2>🎮 Word Search 找词闯关</h2>
      <p>选择语言与限时，点击「进入游戏」即开始闯关与倒计时。</p>
      <div class="row">
        <label>语言：<select id="landingLanguage"></select></label>
        <label>限时：
          <select id="landingTimer">
            <option value="60" selected>60 秒</option>
            <option value="120">120 秒</option>
            <option value="180">180 秒</option>
            <option value="0">不限</option>
          </select>
        </label>
      </div>
      <div class="row" style="margin-top:10px;">
        <label>起始关卡：
          <select id="landingLevel">
            <option value="1" selected>第 1 关（10×10 / ≥6词）</option>
            <option value="2">第 2 关（12×12 / ≥6词）</option>
            <option value="3">第 3 关（14×14 / ≥6词）</option>
            <option value="4">第 4 关（16×16 / ≥6词）</option>
            <option value="5">第 5 关（18×18 / ≥6词）</option>
          </select>
        </label>
      </div>
      <div class="footer">
        <button id="enterGame">进入游戏 ▶</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
      <h1>✨ 多语言 Word Search H5（v3 · 至少6词 · 自动计时）</h1>
      <div class="toolbar">
        <div class="levelbar">
          <span class="leveltag">关卡 <span id="levelNo">1</span></span>
          <span class="muted">难度：<span id="levelDesc">10×10 / ≥6词</span></span>
        </div>
        <label>语言：
          <select id="language"></select>
        </label>
        <div class="cta">
          <button id="regen">重开本关</button>
          <button id="nextLevel" class="secondary" style="display:none;">下一关 ▶</button>
        </div>
        <span class="time muted">剩余 <span id="timeLeft">--:--</span></span>
      </div>
    </div>

    <div class="grid-wrap">
      <div class="card">
        <div class="card-h">盘面 <button id="resetBoard" class="ghost">重置盘面</button></div>
        <div class="card-c">
          <div style="position:relative; display:inline-block;">
            <div id="board" class="board"></div>
            <div id="boardOverlay" class="overlay">⏰ 时间到</div>
          </div>
        </div>
      </div>

      <div class="right">
        <div class="card">
          <div class="card-h">目标词</div>
          <div class="card-c"><ul id="words" style="display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:8px;"></ul>
            <div class="muted" style="margin-top:8px;">提示：支持正向或反向选中整条直线（水平/垂直/对角线）。</div>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <div class="card-h">自定义词表（可选）</div>
          <div class="card-c">
            <textarea id="custom" placeholder="用逗号或换行分隔，例如：人工智能, 计算机程序, 机器学习" style="width:100%; height:110px;"></textarea>
            <div style="display:flex; justify-content:flex-end; margin-top:8px;">
              <button id="useCustom" class="secondary">用词表生成</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <div class="card-h">状态</div>
          <div class="card-c">
            <div class="status">
              <div class="muted">已找到：<span id="foundCount">0</span> / <span id="totalCount">0</span></div>
              <div id="allDone" class="done" style="display:none;">全部找到！🎉</div>
              <div id="timeUp" class="timeup">时间到 ⏰</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  // ===== 多语言字母表 + 词库（包含较长词） =====
  const LANGUAGE_PACKS = {
    en: {
      label: "English",
      alphabet: "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),
      dictionary: [
        "MICROPROCESSOR","HYPERPARAMETER","CONFIGURATION","ALGORITHM","COMPUTER","PROGRAMMING","DATABASE","ARCHITECTURE","APPLICATION","DEVELOPMENT",
        "PHOTOGRAPHY","ASTRONOMY","BIODIVERSITY","MOUNTAINEER","WATERFALL","GREENHOUSE","ECOSYSTEM","CONTINENT","PENINSULA",
        "STRAWBERRY","BLUEBERRIES","PINEAPPLE","CHOCOLATE","CINNAMON",
        "APPLE","ORANGE","BANANA","GRAPE","MANGO","PEACH","CHERRY","LEMON",
        "JAVASCRIPT","REACT","KEYBOARD","SCREEN","MOBILE","SERVER","ROUTER",
        "RIVER","MOUNTAIN","OCEAN","FOREST","DESERT","ISLAND","VALLEY","PLAIN","HILL","LAKE",
      ],
    },
    zh: {
      label: "中文（简体）",
      alphabet: "的一是在不了有和人这中大为上个国我以要他时来用们生到作地于出就分对成会可主发年动同工也能下过子说产种面而方后多定行学法所民得经十三之进着等部度家电力里如水化高自二理起小物现实加量都两体制机当使点从业本去把性好应开它合还因由其些然前外天政四日那社义事平形相全表间样与关各重新线内数正心反你明看原又么利比或但质气第向道命此变条只没结解问意建月公无系军很情者最立代想已通并提直题党程展五果料象员革位入常文总次品式活设及管特件长求老头基资边流路级少图山统接知较将组见计别她手角期根论运农指几九区强放决西被干做必战先回则任取据处队南给色光门即保治北造百规热领七海口东导器压志世金增争济阶油思术极交受联什认六共权收证改清己美再采转更单风切打白教速花带安场身车例真务具万每目至达走积示议声报斗完类八离华名确才科张信马节话米整空元况今集温传土许步群广石记需段研界拉林律叫且究观越织装影算低持音众书布复容儿须际商非验连断深难近矿千周委素技备半办青省列习便响约支般史感劳便食掉".split("") ,
      dictionary: [
        "人工智能","机器学习","深度学习","计算机程序","图像识别","自然语言","神经网络","大数据集","操作系统","分布式网",
        "太空探索","生物多样","环境保护","可持续性","高等数学","量子计算","计算机图形",
        "电脑","手机","屏幕","网络","程序","算法","数据","模型","游戏","机器人",
        "苹果","香蕉","葡萄","西瓜","樱桃","芒果","柠檬","桃子",
        "山脉","河流","森林","沙漠","海洋","湖泊","平原","岛屿","山谷","天空",
      ],
    },
    ja: {
      label: "日本語（ひらがな）",
      alphabet: "あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをん".split("") ,
      dictionary: [
        "こうそくどうろ","でんしじしょ","にほんごがく","けいざいがく","じょうほうがく",
        "りんご","みかん","いちご","すいか","さくら","ねこ","いぬ","やま","かわ","うみ","しま","くも","かぜ",
      ],
    },
    ko: {
      label: "한국어(한글)",
      alphabet: "가나다라마바사아자차카타파하거너더러머버써어요유이오무바사자차카타파하".split("") ,
      dictionary: [
        "인공지능","기계학습","딥러닝","운영체제","데이터베이스","자연어처리",
        "사과","바나나","포도","복숭아","수박","라면","김치","산","강","바다","숲","섬","하늘",
      ],
    },
    es: {
      label: "Español",
      alphabet: "ABCDEFGHIJKLMNÑOPQRSTUVWXYZ".split("") ,
      dictionary: [
        "MICROPROCESADOR","CONFIGURACION","ALGORITMO","PROGRAMACION","APLICACION","DESARROLLO",
        "BIODIVERSIDAD","ASTRONOMIA","FOTOGRAFIA","CONTINENTE","PENINSULA",
        "FRAMBUESA","ARANDANOS","CHOCOLATE","CINAMONO",
        "MANZANA","NARANJA","PLATANO","PERA","UVA","MANGO","MELON","LIMON","CEREZA","FRESA",
        "RIO","MONTAÑA","BOSQUE","DESIERTO","ISLA","LAGO","VALLE","CIELO","NUBE","VIENTO",
      ],
    },
  };

  const COLORS = ["#fde68a","#bbf7d0","#93c5fd","#fca5a5","#c4b5fd","#fdba74","#86efac","#a5b4fc","#f9a8d4","#7dd3fc","#fecaca","#d9f99d","#99f6e4","#f5d0fe","#fef08a","#d1fae5","#c7d2fe"];

  const DIRECTIONS = [
    { dx: 1, dy: 0 }, { dx: -1, dy: 0 }, { dx: 0, dy: 1 }, { dx: 0, dy: -1 },
    { dx: 1, dy: 1 }, { dx: 1, dy: -1 }, { dx: -1, dy: 1 }, { dx: -1, dy: -1 },
  ];

  function levelPreset(level) {
    if (level <= 1) return { size: 10, words: 6 };
    if (level === 2) return { size: 12, words: 8 };
    if (level === 3) return { size: 14, words: 10 };
    if (level === 4) return { size: 16, words: 12 };
    return { size: 18, words: 14 };
  }

  const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
  const choice = (arr) => arr[randInt(0, arr.length - 1)];
  const normalize = (str) => (/^[A-Za-zÑñ]+$/.test(str) ? str.toUpperCase() : str);

  // 构建候选词（优先短词，允许少量长词；过滤掉长度 > grid size 的词）
  function buildCandidates(dict, expected, size) {
    const filtered = dict.filter(w => w.length <= size);
    const sorted = [...filtered].sort((a,b)=>a.length-b.length); // 短到长
    const longTail = filtered.filter(w => w.length > Math.max(5, Math.floor(size*0.7)));
    // 拿前 expected*2 个短词 + 少量长词（最多 expected）混合
    const shortPick = sorted.slice(0, Math.min(sorted.length, expected*2));
    // 打乱
    for (let i = shortPick.length - 1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [shortPick[i], shortPick[j]] = [shortPick[j], shortPick[i]]; }
    const longPick = longTail.slice(0, Math.min(longTail.length, expected));
    const merged = [...shortPick, ...longPick];
    // 去重
    return Array.from(new Set(merged)).map(normalize);
  }

  const cellsInLine = (x0, y0, x1, y1) => {
    const dx = Math.sign(x1 - x0);
    const dy = Math.sign(y1 - y0);
    const len = Math.max(Math.abs(x1 - x0), Math.abs(y1 - y0));
    if (!((dx === 0 || dy === 0) || Math.abs(x1 - x0) === Math.abs(y1 - y0))) return [];
    const out = [];
    for (let k = 0; k <= len; k++) out.push([x0 + dx * k, y0 + dy * k]);
    return out;
  };

  const createEmptyGrid = (size, fill = null) => Array.from({ length: size }, () => Array.from({ length: size }, () => fill));

  const canPlace = (grid, word, x, y, dir) => {
    const n = grid.length;
    for (let k = 0; k < word.length; k++) {
      const nx = x + dir.dx * k, ny = y + dir.dy * k;
      if (nx < 0 || ny < 0 || nx >= n || ny >= n) return false;
      const cell = grid[ny][nx];
      if (cell && cell.letter !== word[k]) return false;
    }
    return true;
  };

  const placeWord = (grid, word, dirOptions = DIRECTIONS) => {
    const n = grid.length; const dirs = [...dirOptions];
    for (let attempt = 0; attempt < 400; attempt++) {
      const dir = choice(dirs); const x = randInt(0, n - 1); const y = randInt(0, n - 1);
      if (!canPlace(grid, word, x, y, dir)) continue;
      const positions = [];
      for (let k = 0; k < word.length; k++) {
        const nx = x + dir.dx * k, ny = y + dir.dy * k;
        positions.push([nx, ny]);
        if (!grid[ny][nx]) grid[ny][nx] = { letter: word[k], words: new Set([word]) };
        else { grid[ny][nx].letter = word[k]; grid[ny][nx].words.add(word); }
      }
      return positions;
    }
    return null;
  };

  const fillRandom = (grid, alphabet) => {
    const n = grid.length;
    for (let y = 0; y < n; y++) for (let x = 0; x < n; x++) if (!grid[y][x]) grid[y][x] = { letter: choice(alphabet), words: new Set() };
    return grid;
  };

  function generateBoard({ langKey, level, customWords }) {
    const { alphabet, dictionary } = LANGUAGE_PACKS[langKey];
    const preset = levelPreset(level);
    const size = preset.size;
    const expected = Math.max(6, preset.words);
    const grid = createEmptyGrid(size);

    let candidates;
    if (customWords && customWords.length > 0) {
      candidates = customWords.filter(w => w && w.length <= size).map(normalize);
    } else {
      candidates = buildCandidates(dictionary, expected, size);
    }

    const placements = {};
    const placedWords = [];
    // 尝试放置，直到达到 expected 或候选耗尽；不足则补充短词继续尝试
    const tryPlace = (list) => {
      for (const w of list) {
        if (placedWords.length >= expected) break;
        if (placements[w]) continue;
        const pos = placeWord(grid, w);
        if (pos) { placements[w] = pos; placedWords.push(w); }
      }
    };

    tryPlace(candidates);

    if (placedWords.length < 6) {
      // 兜底：从字典里拿最短的词补充
      const shortest = [...dictionary].filter(w => w.length <= size).sort((a,b)=>a.length-b.length).map(normalize);
      tryPlace(shortest);
    }

    fillRandom(grid, alphabet);

    // 颜色为每个单词分配唯一值
    const colorMap = {};
    placedWords.forEach((w, i) => { colorMap[w] = COLORS[i % COLORS.length]; });

    return { grid, placements, selectedWords: placedWords, colorMap, size, words: placedWords.length };
  }

  // ===== UI & 交互（自动计时 + 关卡 + 登陆界面） =====
  const els = {
    // landing
    landing: document.getElementById('landing'),
    landingLanguage: document.getElementById('landingLanguage'),
    landingTimer: document.getElementById('landingTimer'),
    landingLevel: document.getElementById('landingLevel'),
    enterGame: document.getElementById('enterGame'),
    // in-game
    levelNo: document.getElementById('levelNo'),
    levelDesc: document.getElementById('levelDesc'),
    language: document.getElementById('language'),
    timeLeft: document.getElementById('timeLeft'),
    regen: document.getElementById('regen'),
    nextLevel: document.getElementById('nextLevel'),
    resetBoard: document.getElementById('resetBoard'),
    board: document.getElementById('board'),
    boardOverlay: document.getElementById('boardOverlay'),
    words: document.getElementById('words'),
    custom: document.getElementById('custom'),
    useCustom: document.getElementById('useCustom'),
    foundCount: document.getElementById('foundCount'),
    totalCount: document.getElementById('totalCount'),
    allDone: document.getElementById('allDone'),
    timeUp: document.getElementById('timeUp'),
  };

  // 填充语言选择（登陆页 & 游戏内）
  function populateLanguages(selectEl, defaultKey='en') {
    selectEl.innerHTML = '';
    for (const k of Object.keys(LANGUAGE_PACKS)) {
      const opt = document.createElement('option');
      opt.value = k; opt.textContent = LANGUAGE_PACKS[k].label; if (k === defaultKey) opt.selected = true;
      selectEl.appendChild(opt);
    }
  }
  populateLanguages(els.landingLanguage, 'en');
  populateLanguages(els.language, 'en');

  let state = {
    level: 1, langKey: 'en', board: null, found: new Set(), drag: null,
    timeLimit: 60, timeLeft: 0, timer: null, active: false
  };

  function presetToText(level) {
    const p = levelPreset(level);
    return `${p.size}×${p.size} / ≥6词`;
  }

  function formatTime(s) {
    if (s <= 0) return "00:00";
    const m = Math.floor(s / 60).toString().padStart(2, '0');
    const ss = (s % 60).toString().padStart(2, '0');
    return `${m}:${ss}`;
  }

  function clearTimer() { if (state.timer) { clearInterval(state.timer); state.timer = null; } }
  function resetTimerUI() {
    els.timeLeft.textContent = state.timeLimit > 0 ? formatTime(state.timeLimit) : "--:--";
    els.boardOverlay.style.display = 'none'; els.timeUp.style.display = 'none';
  }

  function startCountdown() {
    clearTimer();
    if (state.timeLimit <= 0) { state.active = true; els.timeLeft.textContent = "--:--"; return; }
    state.timeLeft = state.timeLimit; els.timeLeft.textContent = formatTime(state.timeLeft);
    state.active = true;
    state.timer = setInterval(() => {
      state.timeLeft -= 1; els.timeLeft.textContent = formatTime(state.timeLeft);
      if (state.timeLeft <= 0) { clearTimer(); state.active = false; els.boardOverlay.style.display = 'flex'; els.timeUp.style.display = 'block'; }
    }, 1000);
  }

  function stopGameIfFinished() {
    if (state.found.size === state.board.selectedWords.length && state.board.selectedWords.length > 0) {
      els.allDone.style.display = 'block'; els.nextLevel.style.display = 'inline-block';
      clearTimer(); state.active = false;
    } else {
      els.allDone.style.display = 'none'; els.nextLevel.style.display = 'none';
    }
  }

  function rebuild(customWords) {
    state.board = generateBoard({ langKey: state.langKey, level: state.level, customWords });
    state.found = new Set();
    render();
    clearTimer(); state.active = false; resetTimerUI();
    els.levelNo.textContent = state.level;
    els.levelDesc.textContent = presetToText(state.level);
    // 自动开始倒计时
    startCountdown();
  }

  function render() {
    const n = state.board.grid.length;
    els.board.style.gridTemplateColumns = `repeat(${n}, 2.2rem)`;
    els.board.style.gridTemplateRows = `repeat(${n}, 2.2rem)`;

    // 构建格子
    els.board.innerHTML = '';
    for (let y = 0; y < n; y++) {
      for (let x = 0; x < n; x++) {
        const cell = state.board.grid[y][x];
        const div = document.createElement('div');
        div.className = 'cell';
        div.textContent = cell.letter;
        div.dataset.x = x; div.dataset.y = y;
        div.onpointerdown = (e) => { e.preventDefault(); if (!state.active) return; startDrag(x, y); };
        div.onpointerenter = (e) => { if (e.buttons === 1 && state.active) moveDrag(x, y); };
        els.board.appendChild(div);
      }
    }

    // 词表
    els.words.innerHTML = '';
    for (const w of state.board.selectedWords) {
      const li = document.createElement('li');
      li.className = 'word';
      const dot = document.createElement('span');
      dot.className = 'dot'; dot.style.background = state.board.colorMap[w];
      const txt = document.createElement('span'); txt.textContent = w;
      li.appendChild(dot); li.appendChild(txt);
      li.dataset.word = w;
      els.words.appendChild(li);
    }

    els.foundCount.textContent = 0;
    els.totalCount.textContent = state.board.selectedWords.length;
    els.allDone.style.display = 'none';
    els.nextLevel.style.display = 'none';

    // 拖选结束
    els.board.onpointerup = () => { if (state.active) endDrag(); };
  }

  function cellsToString(cells) { return cells.map(([cx, cy]) => state.board.grid[cy][cx].letter).join(''); }

  function highlight(cells, color, on, isDrag=false) {
    for (const [x, y] of cells) {
      const idx = y * state.board.grid.length + x;
      const el = els.board.children[idx];
      if (!el) continue;
      if (isDrag) el.classList.toggle('drag', on);
      else {
        if (on) { el.style.background = color; }
        else { el.style.background = 'rgba(255,255,255,.9)'; }
      }
    }
  }

  function startDrag(x, y) {
    state.drag = { start: [x, y], end: [x, y], cells: [[x, y]] };
    highlight(state.drag.cells, null, true, true);
  }

  function moveDrag(x, y) {
    if (!state.drag) return;
    const cells = cellsInLine(state.drag.start[0], state.drag.start[1], x, y);
    highlight(state.drag.cells, null, false, true);
    state.drag = { ...state.drag, end: [x, y], cells };
    highlight(state.drag.cells, null, true, true);
  }

  function endDrag() {
    if (!state.drag) return;
    const text = cellsToString(state.drag.cells);
    const rev = [...text].reverse().join('');
    for (const w of state.board.selectedWords) {
      if (!state.found.has(w) && (text === w || rev === w)) {
        state.found.add(w);
        const coords = state.board.placements[w];
        const color = state.board.colorMap[w];
        highlight(coords, color, true, false);
        const li = Array.from(els.words.children).find(li => li.dataset.word === w);
        if (li) li.classList.add('found');
      }
    }
    els.foundCount.textContent = state.found.size;
    stopGameIfFinished();

    // 清理拖选高亮（仅拖拽临时效果）
    highlight(state.drag.cells, null, false, true);
    state.drag = null;
  }

  // 事件绑定
  els.language.addEventListener('change', (e) => { state.langKey = e.target.value; rebuild(); });
  els.resetBoard.addEventListener('click', () => { rebuild(); });
  els.regen.addEventListener('click', () => {
    const customWords = els.custom.value.split(/\n|,|;|\s+/).map(s=>s.trim()).filter(Boolean);
    rebuild(customWords.length ? customWords : undefined);
  });
  els.useCustom.addEventListener('click', () => {
    const customWords = els.custom.value.split(/\n|,|;|\s+/).map(s=>s.trim()).filter(Boolean);
    rebuild(customWords);
  });
  els.nextLevel.addEventListener('click', () => { state.level += 1; rebuild(); });

  // 进入游戏（登陆页确认后自动开始倒计时）
  function populateLanguages(selectEl, defaultKey='en') {
    selectEl.innerHTML = '';
    for (const k of Object.keys(LANGUAGE_PACKS)) {
      const opt = document.createElement('option');
      opt.value = k; opt.textContent = LANGUAGE_PACKS[k].label; if (k === defaultKey) opt.selected = true;
      selectEl.appendChild(opt);
    }
  }
  // 已在上方定义并调用，此处无需重复

  document.getElementById('enterGame').addEventListener('click', () => {
    state.langKey = document.getElementById('landingLanguage').value;
    state.level = parseInt(document.getElementById('landingLevel').value, 10);
    state.timeLimit = parseInt(document.getElementById('landingTimer').value, 10);
    // 同步到内页的语言选择
    document.getElementById('language').value = state.langKey;
    document.getElementById('landing').style.display = 'none';
    rebuild();
  });

  // 初始化（停留在登陆页）
  els.timeLeft.textContent = "--:--";
  </script>
</body>
</html>
